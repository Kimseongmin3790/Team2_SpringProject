<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.SellerMapper"> <!-- SellerMapper 인터페이스와 연결됩니다. -->

    <!-- SellerVO와 User 객체를 매핑하기 위한 resultMap -->
    <resultMap id="sellerWithUserResultMap" type="com.example.TeamProject.model.SellerVO">
        <id property="userId" column="USER_ID"/>
        <result property="businessName" column="BUSINESS_NAME"/>
        <result property="businessLi" column="BUSINESS_LI"/>
        <result property="verified" column="VERIFIED"/>
        <result property="businessNumber" column="BUSINESS_NUMBER"/>
        <result property="account" column="ACCOUNT"/>
        <result property="bankName" column="BANKNAME"/>
        <result property="lat" column="LAT"/>
        <result property="lng" column="LNG"/>

        <!-- 연관된 User 객체 매핑 -->
        <association property="user" javaType="com.example.TeamProject.model.User">
            <result property="name" column="USER_NAME"/>
            <result property="address" column="USER_ADDRESS"/>
        </association>
    </resultMap>

    <!-- 판매자 정보 가져오기 -->
    <select id="getSellerInfo" parameterType="String" resultMap="sellerWithUserResultMap">
        SELECT
            s.USER_ID,
            s.BUSINESS_NAME,
            s.BUSINESS_LI,
            s.VERIFIED,
            s.BUSINESS_NUMBER,
            s.ACCOUNT,
            s.BANKNAME,
            s.LAT,
            s.LNG,
            u.NAME AS USER_NAME,
            u.ADDRESS AS USER_ADDRESS
        FROM
            SELLER_INFO s
        JOIN
            USERS u ON s.USER_ID = u.USER_ID
        WHERE
            s.USER_ID = #{userId}
    </select>
    
    <!--농가정보수정-->
    <update id="updateSellerInfo" parameterType="com.example.TeamProject.model.SellerVO">
	    UPDATE SELLER_INFO
	    SET
	        BUSINESS_NAME = #{businessName} 
	    WHERE USER_ID = #{userId}
	</update>
	
	 <!-- 사용자 정보 수정 -->
	 <update id="updateUserInfo" parameterType="com.example.TeamProject.model.User">
	     UPDATE USERS
	     SET
	         NAME = #{name, jdbcType=VARCHAR},  
	         ADDRESS = #{address, jdbcType=VARCHAR}, 
	         UDATETIME = SYSDATE
	     WHERE USER_ID = #{userId}
	 </update>
	 
	<!-- 사용자 전화번호(USERS.PHONE) 업데이트 쿼리 -->
	<update id="updateUserPhone" parameterType="com.example.TeamProject.model.User">
	    UPDATE USERS
	    SET
	        PHONE = #{phone, jdbcType=VARCHAR},
	        UDATETIME = SYSDATE
	    WHERE USER_ID = #{userId}
	</update>
	
	<!-- 판매자 계좌 정보(SELLER_INFO.ACCOUNT, BANKNAME) 업데이트 쿼리 -->
	<update id="updateSellerAccountInfo" parameterType="com.example.TeamProject.model.SellerVO">
	    UPDATE SELLER_INFO
	    SET
	        ACCOUNT = #{account, jdbcType=VARCHAR},
	        BANKNAME = #{bankName, jdbcType=VARCHAR}
	    WHERE USER_ID = #{userId}
	</update>
	
	    <!-- 대시보드 - 오늘 주문 건수 -->
    <select id="getTodayOrdersCount" parameterType="String" resultType="int">
        SELECT COUNT(DISTINCT O.ORDER_NO)
        FROM ORDERS O
        JOIN ORDER_ITEM OI ON O.ORDER_NO = OI.ORDER_NO
        JOIN PRODUCT P ON OI.PRODUCT_NO = P.PRODUCT_NO
        WHERE P.SELLER_ID = #{sellerId}
          AND TRUNC(O.ORDERDATE) = TRUNC(SYSDATE)
    </select>

    <!-- 대시보드 - 오늘 매출 -->
    <select id="getTodaySalesAmount" parameterType="String" resultType="Long">
        SELECT NVL(SUM(O.TOTAL_PRICE), 0)
        FROM ORDERS O
        JOIN ORDER_ITEM OI ON O.ORDER_NO = OI.ORDER_NO
        JOIN PRODUCT P ON OI.PRODUCT_NO = P.PRODUCT_NO
        WHERE P.SELLER_ID = #{sellerId}
          AND TRUNC(O.ORDERDATE) = TRUNC(SYSDATE)
    </select>

    <!-- 대시보드 - 총 등록 상품 수 -->
    <select id="getTotalProductsCount" parameterType="String" resultType="int">
        SELECT COUNT(PRODUCT_NO)
        FROM PRODUCT
        WHERE SELLER_ID = #{sellerId}
    </select>

    <!-- 대시보드 - 평균 평점 -->
    <select id="getAverageRating" parameterType="String" resultType="Double">
        SELECT NVL(AVG(R.RATING), 0.0)
        FROM REVIEW R
        JOIN PRODUCT P ON R.PRODUCT_NO = P.PRODUCT_NO
        WHERE P.SELLER_ID = #{sellerId}
    </select>

    <!-- 대시보드 - 최근 주문 목록 (최대 3개) -->
    <select id="getRecentOrders" parameterType="String" resultType="com.example.TeamProject.model.Order">
	    SELECT *
	    FROM (
	        SELECT
	            o.ORDER_NO, o.ORDERDATE, o.TOTAL_PRICE, o.STATUS,
	            (SELECT p_inner.PNAME FROM PRODUCT p_inner JOIN ORDER_ITEM oi_inner ON p_inner.PRODUCT_NO =
	            oi_inner.PRODUCT_NO WHERE oi_inner.ORDER_NO = o.ORDER_NO AND ROWNUM = 1) as PRODUCT_NAME,
	            (SELECT COUNT(*) FROM ORDER_ITEM oi_inner WHERE oi_inner.ORDER_NO = o.ORDER_NO) as PRODUCT_COUNT
	        FROM
	            ORDERS o
	        WHERE
	            EXISTS (
	                SELECT 1 FROM ORDER_ITEM oi_sec JOIN PRODUCT p_sec ON oi_sec.PRODUCT_NO = p_sec.PRODUCT_NO
	                WHERE oi_sec.ORDER_NO = o.ORDER_NO AND p_sec.SELLER_ID = #{sellerId}
	            )
	        ORDER BY o.ORDERDATE DESC
	    )
	    WHERE ROWNUM &lt; 3
	</select>
	
	    <!-- 매출 내역 조회 -->
    <select id="getSalesHistory" parameterType="hashmap" resultType="com.example.TeamProject.model.SalesHistoryDTO">
        SELECT
            <choose>
                <when test="type == 'monthly'">
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM-DD') AS period
                </when>
                <when test="type == 'yearly'">
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM') AS period
                </when>
                <otherwise> 
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM-DD') AS period
                </otherwise>
            </choose>
            , SUM(oi.PRICE * oi.QUANTITY) AS totalSales
            , TRUNC(SUM(oi.PRICE * oi.QUANTITY) * 0.1) AS platformFee
        FROM
            ORDERS o
        JOIN
            ORDER_ITEM oi ON o.ORDER_NO = oi.ORDER_NO
        JOIN
            PRODUCT p ON oi.PRODUCT_NO = p.PRODUCT_NO
        WHERE
            p.SELLER_ID = #{sellerId}
            <if test="type == 'monthly' and month != null and month != ''">
                AND TO_CHAR(o.ORDERDATE, 'YYYY-MM') = #{month}
            </if>
            <if test="type == 'yearly' and year != null and year != ''">
                AND TO_CHAR(o.ORDERDATE, 'YYYY') = #{year}
            </if>
            <if test="type == 'daily' and date != null and date != ''">
                AND TRUNC(o.ORDERDATE) = TO_DATE(#{date}, 'YYYY-MM-DD')
            </if>
        GROUP BY
            <choose>
                <when test="type == 'monthly'">
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM-DD')
                </when>
                <when test="type == 'yearly'">
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM')
                </when>
                <otherwise> 
                    TO_CHAR(o.ORDERDATE, 'YYYY-MM-DD')
                </otherwise>
            </choose>
        ORDER BY
            period DESC
    </select>
    
    <!-- 판매자 인증 상태 업데이트 -->
	<update id="updateSellerVerification">
	    UPDATE SELLER_INFO
	    SET
	        VERIFIED = #{status}
	    WHERE
	        USER_ID = #{userId}
	</update>

	 
</mapper>