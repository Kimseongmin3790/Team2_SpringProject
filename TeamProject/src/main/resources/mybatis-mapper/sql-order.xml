<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.OrderMapper">

    
    <resultMap id="orderResultMap" type="com.example.TeamProject.model.Order">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="buyerId" column="BUYER_ID"/>
        <result property="orderDate" column="ORDERDATE"/>
        <result property="totalPrice" column="TOTAL_PRICE"/>
        <result property="status" column="STATUS"/>
        <result property="receivName" column="RECEIV_NAME"/>
        <result property="receivPhone" column="RECEIV_PHONE"/>
        <result property="deliverAddr" column="DELIVER_ADDR"/>
        <result property="memo" column="MEMO"/>
        <result property="uDatetime" column="UDATETIME"/>

        <collection property="items" ofType="com.example.TeamProject.model.OrderItem"
                    select="selectOrderItemsByOrderNo" column="ORDER_NO"/>
    </resultMap>

    <resultMap id="orderItemResultMap" type="com.example.TeamProject.model.OrderItem">
        <id property="orderItemNo" column="ORDER_ITEM_NO"/>
        <result property="orderNo" column="ORDER_NO"/>
        <result property="productNo" column="PRODUCT_NO"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="price" column="PRICE"/>
        <result property="productName" column="PNAME"/>
    </resultMap>

    <!-- 사용자 ID로 주문 내역을 조회하는 메인 쿼리 -->
    <select id="selectOrderHistoryByUserId" resultMap="orderResultMap">
        SELECT
            ORDER_NO,
            BUYER_ID,
            TO_CHAR(ORDERDATE, 'YYYY-MM-DD HH24:MI:SS') AS ORDERDATE,
            TOTAL_PRICE,
            STATUS,
            RECEIV_NAME,
            RECEIV_PHONE,
            DELIVER_ADDR,
            MEMO,
            TO_CHAR(UDATETIME, 'YYYY-MM-DD HH24:MI:SS') AS UDATETIME
        FROM ORDERS
        WHERE BUYER_ID = #{userId}
        ORDER BY ORDERDATE DESC
    </select>

    <!-- 특정 주문 번호에 해당하는 상품 목록을 조회하는 서브 쿼리 -->
    <select id="selectOrderItemsByOrderNo" resultMap="orderItemResultMap">
        SELECT
            OI.ORDER_ITEM_NO,
            OI.ORDER_NO,
            OI.PRODUCT_NO,
            OI.QUANTITY,
            OI.PRICE,
            P.PNAME
        FROM ORDER_ITEM OI
        JOIN PRODUCT P ON OI.PRODUCT_NO = P.PRODUCT_NO
        WHERE OI.ORDER_NO = #{orderNo}
    </select>

</mapper>