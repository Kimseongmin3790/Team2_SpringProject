<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.OrderMapper">

    <!-- Order DTO에 대한 resultMap 정의 -->
    <resultMap id="orderResultMap" type="com.example.TeamProject.model.Order">
        <id property="orderNo" column="orderNo"/> <!-- SQL 별칭과 일치 -->
        <result property="buyerId" column="buyerId"/> <!-- SQL 별칭과 일치 -->
        <result property="orderDate" column="orderDate"/> <!-- SQL 별칭과 일치 -->
        <result property="totalPrice" column="totalAmount"/> <!-- SQL 별칭과 일치 -->
        <result property="status" column="status"/> <!-- SQL 별칭과 일치 -->
        <result property="receivName" column="receivName"/> <!-- SQL 별칭과 일치 -->
        <result property="receivPhone" column="receivPhone"/> <!-- SQL 별칭과 일치 -->
        <result property="deliverAddr" column="deliverAddr"/> <!-- SQL 별칭과 일치 -->
        <result property="memo" column="memo"/> <!-- SQL 별칭과 일치 -->
        <result property="uDatetime" column="uDatetime"/> <!-- SQL 별칭과 일치 -->
        <result property="imageUrl" column="imageUrl"/> <!-- SQL 별칭과 일치 -->

        <!-- selectOrderListBySeller 쿼리에서 추가로 사용하는 필드들 -->
        <result property="productName" column="productName"/> <!-- SQL 별칭과 일치 -->
        <result property="productCount" column="productCount"/> <!-- SQL 별칭과 일치 -->
        <result property="buyerName" column="buyerName"/> <!-- SQL 별칭과 일치 -->

      
    </resultMap>

    <resultMap id="orderItemResultMap" type="com.example.TeamProject.model.OrderItem">
        <id property="orderItemNo" column="ORDER_ITEM_NO"/>
        <result property="orderNo" column="ORDER_NO"/>
        <result property="productNo" column="PRODUCT_NO"/>
        <result property="quantity" column="QUANTITY"/>
        <result property="price" column="PRICE"/>
        <result property="productName" column="PNAME"/>
    </resultMap>

    <!-- 사용자 ID로 주문 내역을 조회하는 메인 쿼리 -->
    <select id="selectOrderHistoryByUserId" resultMap="orderResultMap">
        SELECT
            ORDER_NO AS orderNo,
            BUYER_ID AS buyerId,
            TO_CHAR(ORDERDATE, 'YYYY-MM-DD HH24:MI:SS') AS orderDate,
            TOTAL_PRICE AS totalAmount,
            STATUS AS status,
            RECEIV_NAME AS receivName,
            RECEIV_PHONE AS receivPhone,
            DELIVER_ADDR AS deliverAddr,
            MEMO AS memo,
            TO_CHAR(UDATETIME, 'YYYY-MM-DD HH24:MI:SS') AS uDatetime
        FROM ORDERS
        WHERE BUYER_ID = #{userId}
        ORDER BY ORDERDATE DESC
    </select>

    <!-- 특정 주문 번호에 해당하는 상품 목록을 조회하는 서브 쿼리 -->
    <select id="selectOrderItemsByOrderNo" resultType="com.example.TeamProject.model.OrderItem">
        SELECT
            OI.ORDER_ITEM_NO,
            OI.ORDER_NO,
            OI.PRODUCT_NO,
            OI.QUANTITY,
            OI.PRICE,
            P.PNAME AS productName,
            (SELECT PI.IMAGE_URL FROM PRODUCT_IMAGE PI WHERE PI.PRODUCT_NO = P.PRODUCT_NO AND
PI.IS_THUMBNAIL = 'Y' AND ROWNUM = 1) AS imageUrl,
            (SELECT COUNT(*) FROM REVIEW R WHERE R.ORDER_ITEM_NO = OI.ORDER_ITEM_NO) AS hasReview
        FROM ORDER_ITEM OI
        JOIN PRODUCT P ON OI.PRODUCT_NO = P.PRODUCT_NO
        WHERE OI.ORDER_NO = #{orderNo}
    </select>

    <!-- 판매자 ID 주문목록 조회 -->
    <select id="selectOrderListBySeller" resultMap="orderResultMap" parameterType="java.util.HashMap">
        WITH ORDER_PRODUCTS AS (
            SELECT
                oi.ORDER_NO,
                oi.PRODUCT_NO,
                p.PNAME,
                ROW_NUMBER() OVER(PARTITION BY oi.ORDER_NO ORDER BY oi.ORDER_ITEM_NO) as rn,
                COUNT(*) OVER(PARTITION BY oi.ORDER_NO) as productCount
            FROM ORDER_ITEM oi
            JOIN PRODUCT p ON oi.PRODUCT_NO = p.PRODUCT_NO
            WHERE p.SELLER_ID = #{sellerId}
        )
        SELECT
            o.ORDER_NO AS orderNo,
            o.BUYER_ID AS buyerId,
            o.ORDERDATE AS orderDate,
            o.TOTAL_PRICE AS totalAmount,
            o.STATUS AS status,
            op.PNAME AS productName,
            op.productCount AS productCount,
            u.NAME AS buyerName,
            o.RECEIV_NAME AS receivName,
            o.RECEIV_PHONE AS receivPhone,
            o.DELIVER_ADDR AS deliverAddr,
            o.MEMO AS memo,
            o.UDATETIME AS uDatetime
        FROM ORDERS o
        JOIN USERS u ON o.BUYER_ID = u.USER_ID
        JOIN ORDER_PRODUCTS op ON o.ORDER_NO = op.ORDER_NO AND op.rn = 1
        ORDER BY o.ORDERDATE DESC
    </select>

</mapper>