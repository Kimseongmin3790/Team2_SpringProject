<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.ReviewMapper">

	    <!-- 리뷰 목록 조회를 위한 resultMap -->
    <resultMap id="productReviewListResultMap" type="com.example.TeamProject.model.Review">
        <id property="reviewNo" column="REVIEW_NO"/>
        <result property="userId" column="USER_ID"/>
        <result property="productNo" column="PRODUCT_NO"/>
        <result property="orderItemNo" column="ORDER_ITEM_NO"/>
        <result property="rating" column="RATING"/>
        <result property="content" column="CONTENT"/>
        <result property="createdAt" column="CREATED_AT"/> 
        <result property="productName" column="PRODUCTNAME"/>
        <result property="imageUrl" column="IMAGEURL"/>
        <collection property="reviewImages" ofType="string" select="selectReviewImageUrlsByReviewNo" column="REVIEW_NO"/> 
    </resultMap>
    
    <!-- 리뷰 상세 조회를 위한 resultMap -->
    <resultMap id="reviewDetailResultMap" type="com.example.TeamProject.model.Review">
	    <id property="reviewNo" column="REVIEW_NO"/>
	    <result property="userId" column="USER_ID"/>
	    <result property="productNo" column="PRODUCT_NO"/>
	    <result property="orderItemNo" column="ORDER_ITEM_NO"/>
	    <result property="rating" column="RATING"/>
	    <result property="content" column="CONTENT"/>
	    <result property="cdate" column="CDATE"/> 
	    <result property="productName" column="PRODUCTNAME"/>
	    <result property="imageUrl" column="IMAGEURL"/> 
	    <result property="sellerName" column="SELLERNAME"/> 
	    <result property="orderdate" column="ORDERDATE"/> 
	</resultMap>


	
    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="com.example.TeamProject.model.Review"
            useGeneratedKeys="true" keyProperty="reviewNo">
        <selectKey keyProperty="reviewNo" resultType="int" order="BEFORE">
            SELECT REVIEW_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO REVIEW (
            REVIEW_NO, USER_ID, PRODUCT_NO, ORDER_ITEM_NO, RATING, CONTENT, CREATED_AT, RECOMMEND
        ) VALUES (
            #{reviewNo}, #{userId}, #{productNo}, #{orderItemNo}, #{rating}, #{content}, SYSDATE, 0
        )
    </insert>

    <!-- 리뷰 이미지 등록 -->
    <insert id="insertReviewImage" parameterType="com.example.TeamProject.model.ReviewImage">
        <selectKey keyProperty="imageNo" resultType="int" order="BEFORE">
            SELECT REVIEW_IMAGE_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO REVIEW_IMAGE (
            IMAGE_NO, REVIEW_NO, IMAGE_URL, CDATETIME, UDATETIME
        ) VALUES (
            #{imageNo}, #{reviewNo}, #{imageUrl}, SYSDATE, SYSDATE
        )
    </insert>
    
    <select id="selectReviewProductInfo" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
	    SELECT
	        P.PNAME AS PNAME,
	        U.NAME AS SELLERNAME,
	        (SELECT PI.IMAGE_URL FROM PRODUCT_IMAGE PI WHERE PI.PRODUCT_NO = P.PRODUCT_NO AND PI.IS_THUMBNAIL= 'Y' AND ROWNUM = 1) AS IMAGEURL,
	        TO_CHAR(O.ORDERDATE, 'YYYY.MM.DD') AS ORDERDATE
	    FROM
	        PRODUCT P
	    LEFT JOIN
	        USERS U ON P.SELLER_ID = U.USER_ID
	    LEFT JOIN
	        ORDER_ITEM OI ON P.PRODUCT_NO = OI.PRODUCT_NO
	    LEFT JOIN
	        ORDERS O ON OI.ORDER_NO = O.ORDER_NO
	    WHERE
	        P.PRODUCT_NO = #{productNo}
	        AND OI.ORDER_ITEM_NO = #{orderItemNo}
	</select>
	
		<!-- 사용자 ID로 리뷰 목록 조회 -->
	    <select id="selectReviewsByUserId" parameterType="string" resultType="com.example.TeamProject.model.Review">
        SELECT
            R.REVIEW_NO,
            R.USER_ID,
            R.PRODUCT_NO,
            R.ORDER_ITEM_NO,
            R.RATING,
            R.CONTENT,
            TO_CHAR(R.CREATED_AT, 'YYYY.MM.DD') AS cdate, 
            P.PNAME AS productName, 
            (SELECT PI.IMAGE_URL FROM PRODUCT_IMAGE PI WHERE PI.PRODUCT_NO = R.PRODUCT_NO AND PI.IS_THUMBNAIL = 'Y' AND ROWNUM = 1) AS imageUrl
        FROM
            REVIEW R
        JOIN
            PRODUCT P ON R.PRODUCT_NO = P.PRODUCT_NO
        WHERE
            R.USER_ID = #{userId}
        ORDER BY
            R.CREATED_AT DESC
    </select>
    
    	<!-- 리뷰 상세 조회 -->
    <select id="selectReviewDetailByReviewNo" parameterType="int" resultType="com.example.TeamProject.model.Review">
        SELECT
            R.REVIEW_NO,
            R.USER_ID,
            R.PRODUCT_NO,
            R.ORDER_ITEM_NO,
            R.RATING,
            R.CONTENT,
            TO_CHAR(R.CREATED_AT, 'YYYY.MM.DD') AS cdate,
            P.PNAME AS productName,
            U.NAME AS sellerName,
            (SELECT PI.IMAGE_URL FROM PRODUCT_IMAGE PI WHERE PI.PRODUCT_NO = P.PRODUCT_NO AND PI.IS_THUMBNAIL = 'Y' AND ROWNUM = 1) AS imageUrl,
            TO_CHAR(O.ORDERDATE, 'YYYY.MM.DD') AS orderdate
        FROM
            REVIEW R
        JOIN
            PRODUCT P ON R.PRODUCT_NO = P.PRODUCT_NO
        LEFT JOIN
            USERS U ON P.SELLER_ID = U.USER_ID
        LEFT JOIN
            ORDER_ITEM OI ON R.ORDER_ITEM_NO = OI.ORDER_ITEM_NO AND R.PRODUCT_NO = OI.PRODUCT_NO
        LEFT JOIN
            ORDERS O ON OI.ORDER_NO = O.ORDER_NO
        WHERE
            R.REVIEW_NO = #{reviewNo}
    </select>

	<!-- 리뷰에 첨부된 이미지 목록 조회 -->
    <select id="selectReviewImagesByReviewNo" parameterType="int" resultType="com.example.TeamProject.model.ReviewImage">
	    SELECT
	        IMAGE_NO,
	        IMAGE_URL
	    FROM
	        REVIEW_IMAGE
	    WHERE
	        REVIEW_NO = #{reviewNo}
	    ORDER BY
	        CDATETIME ASC
	</select>
	
    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="hashmap">
       UPDATE REVIEW
       SET
           RATING = #{rating},
           CONTENT = #{content},
           UDATETIME = SYSDATE
       WHERE
           REVIEW_NO = #{reviewNo}
   </update>

	<!-- 선택된 이미지만 삭제 -->
	<delete id="deleteSpecificReviewImages">
	     DELETE FROM REVIEW_IMAGE
	     WHERE IMAGE_NO IN
	     <foreach item="imageNo" collection="list" open="(" separator="," close=")">
	         #{imageNo}
	     </foreach>
	</delete>
	
	<!-- 리뷰 삭제 -->
	<delete id="deleteReview" parameterType="hashmap">
	    DELETE FROM REVIEW
	    WHERE REVIEW_NO = #{reviewNo} AND USER_ID = #{userId}
	</delete>
	
	<!-- 특정 상품 리뷰 조회-->
	<select id="selectReviewsByProductNo" parameterType="map" resultMap="productReviewListResultMap">
	    SELECT
	        REVIEW_NO,
	        USER_ID,
	        PRODUCT_NO,
	        ORDER_ITEM_NO,
	        RATING,
	        RECOMMEND,
	        CONTENT,
	        CREATED_AT,
	        UDATETIME
	    FROM
	        REVIEW
	    WHERE
	        PRODUCT_NO = #{productNo}
	    ORDER BY
	        CREATED_AT DESC
	    OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<!-- 상품별 전체 리뷰 개수 조회 -->
	<select id="countReviewsByProductNo" parameterType="int" resultType="int">
	    SELECT COUNT(*)
	    FROM REVIEW
	    WHERE PRODUCT_NO = #{productNo}
	</select>
	
	<!-- 특정 리뷰의 이미지 URL 목록을 가져오는 SQL -->
	<select id="selectReviewImageUrlsByReviewNo" parameterType="int" resultType="string">
	    SELECT
	        IMAGE_URL
	    FROM
	        REVIEW_IMAGE
	    WHERE
	        REVIEW_NO = #{reviewNo}
	    ORDER BY
	        CDATETIME ASC
	</select>
	
	<!-- 추천 기록 확인 -->
	<select id="checkIfUserRecommended" parameterType="map" resultType="boolean">
	    SELECT COUNT(*) FROM REVIEW_RECOMMEND
	    WHERE REVIEW_NO = #{reviewNo} AND USER_ID = #{userId}
	</select>
	
	<!-- 추천 기록 추가 -->
	<insert id="insertReviewRecommend" parameterType="map">
	    INSERT INTO REVIEW_RECOMMEND (REVIEW_NO, USER_ID)
	    VALUES (#{reviewNo}, #{userId})
	</insert>
	
	<!-- 추천 기록 삭제 -->
	<delete id="deleteReviewRecommend" parameterType="map">
	    DELETE FROM REVIEW_RECOMMEND
	    WHERE REVIEW_NO = #{reviewNo} AND USER_ID = #{userId}
	</delete>
	
	<!-- 리뷰 추천 수 증가 -->
	<update id="incrementReviewRecommend" parameterType="int">
	    UPDATE REVIEW
	    SET RECOMMEND = RECOMMEND + 1
	    WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<!-- 리뷰 추천 수 감소 -->
	<update id="decrementReviewRecommend" parameterType="int">
	    UPDATE REVIEW
	    SET RECOMMEND = RECOMMEND - 1
	    WHERE REVIEW_NO = #{reviewNo}
	</update>
	
	<!-- 상품별 별점 분포도 조회 -->
	<select id="getRatingDistributionByProductNo" parameterType="int" resultType="hashmap">
	    SELECT
	        RATING,
	        COUNT(*) as COUNT
	    FROM
	        REVIEW
	    WHERE
	        PRODUCT_NO = #{productNo}
	    GROUP BY
	        RATING
	</select>
	

</mapper>