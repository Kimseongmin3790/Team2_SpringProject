<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.UserMapper">
	<insert id="insertUser" parameterType="hashmap">
		INSERT INTO USERS
		VALUES(#{userId}, #{userEmail}, #{hashPwd}, #{userName}, #{userPhone}, #{userRole}, #{userAddr}, SYSDATE, SYSDATE, #{lat}, #{lng}, 'ACTIVE', #{userBirth}, #{userGender})
	</insert>
	
	<insert id="insertSeller" parameterType="hashmap">
	    INSERT INTO SELLER_INFO (
	        USER_ID,
	        BUSINESS_NAME,
	        BUSINESS_LI,
	        VERIFIED,
	        BUSINESS_NUMBER,
	        ACCOUNT,
	        BANKNAME,
	        LAT,
	        LNG,
	        PROFILE_IMG,
	
	        SELLER_TYPE,
	        TELE_SALE_NO,
	        TELE_SALE_FILE,
	        SALE_RAW_AGRI,
	        SALE_PROCESSED,
	        SALE_LIVESTOCK,
	        SALE_SEAFOOD,
	        SALE_OTHER,
	        FOOD_BIZ_TYPE,
	        FOOD_BIZ_NO,
	        LIVESTOCK_BIZ_TYPE,
	        LIVESTOCK_BIZ_NO,
	        SEAFOOD_BIZ_TYPE,
	        SEAFOOD_BIZ_NO
	    )
	    VALUES (
	        #{userId},
	        #{businessName},
	        #{businessLi},
	        #{verified},
	        #{businessNumber},
	        #{account},
	        #{bankName},
	        #{lat},
	        #{lng},
	        #{profileImg},
	
	        #{sellerType},
	        #{teleSaleNo},
	        #{teleSaleFile},
	        #{saleRawAgri},
	        #{saleProcessed},
	        #{saleLivestock},
	        #{saleSeafood},
	        #{saleOther},
	        #{foodBizType},
	        #{foodBizNo},
	        #{livestockBizType},
	        #{livestockBizNo},
	        #{seafoodBizType},
	        #{seafoodBizNo}
	    )
	</insert>

	
	<select id="idCheck" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<select id="loginUser" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<select id="findId" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE NAME = #{userName} AND EMAIL = #{userEmail}
	</select>
	
	<select id="findIdByPhone" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE NAME = #{userName} AND PHONE = #{userPhone}
	</select>
	
	<select id="findPwd" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId} AND NAME = #{userName} AND EMAIL = #{userEmail}
	</select>
	
	<update id="resetPwd" parameterType="hashmap">
		UPDATE USERS
		SET PASSWORD = #{hashPwd}
		WHERE USER_ID = #{userId}
	</update>
	
	<!-- 이메일로 사용자를 찾는 쿼리 -->
	<select id="findByEmail" parameterType="string" resultType="com.example.TeamProject.model.User">
	    SELECT *
	    FROM USERS
	    WHERE EMAIL = #{email}
	</select>

	<!-- 소셜 로그인 사용자를 저장하는 쿼리 -->
	<insert id="insertSocialUser" parameterType="com.example.TeamProject.model.User">
	    INSERT INTO USERS (
	        USER_ID,
	        EMAIL,
	        NAME,
	        USER_ROLE,
	        PASSWORD, <!-- 비밀번호는 null 또는 임의의 값으로 처리 -->
	        PHONE,    
	        ADDRESS, 
	        CDATETIME,
	        UDATETIME
	    ) VALUES (
	        #{userId},
	        #{email},
	        #{name},
	        #{userRole},
	        NULL, <!-- 소셜 로그인 사용자는 비밀번호가 없으므로 임의의 값 지정 -->
	        NVL(#{phone, jdbcType=VARCHAR}, 'NONE'),
	        '소셜 로그인 사용자',    
	        SYSDATE,
	        SYSDATE
	    )
	</insert>
	
	<!-- 소셜 로그인 시 사용자 이름 등을 업데이트 -->
	<update id="updateUser" parameterType="com.example.TeamProject.model.User">
	    UPDATE USERS
		<set>
		    NAME = #{name},
		    <if test="phone != null">
		        PHONE = #{phone, jdbcType=VARCHAR},
		    </if>
		    UDATETIME = SYSDATE
		</set>
		WHERE
   			EMAIL = #{email}
	</update>
	
	<!--유저 프로필 업데이트 -->
	<update id="updateProfile" parameterType="hashmap">
	    UPDATE USERS
	    <set>
	    	EMAIL = #{email},
	        PHONE = #{phone},
	        ADDRESS = #{address},
	        UDATETIME = SYSDATE
	        <if test="hashPwd != null and hashPwd != ''">
	            , PASSWORD = #{hashPwd}
	        </if>
	    </set>
	    WHERE USER_ID = #{userId}
	</update>
	
	<!--계정 삭제 -->
	<update id="updateUserStatus" parameterType="map">
	    UPDATE USERS
	    SET STATUS = #{status},
	        UDATETIME = SYSDATE
	    WHERE USER_ID = #{userId}
	</update>
	
	 <!-- 이미 담은 상품이면 수량만 + N -->
    <update id="updateCartQty" parameterType="hashmap">
        UPDATE CART
        SET
            QUANTITY   = NVL(QUANTITY, 0) + #{quantity},
            ADDED_AT  = SYSDATE
        WHERE USER_ID    = #{userId}
          AND PRODUCT_NO = #{productNo}
    </update>
    
    <!-- 없으면 새로 한 줄 추가 -->
    <insert id="insertCart" parameterType="hashmap">
        INSERT INTO CART
        (CART_NO, PRODUCT_NO, USER_ID,  QUANTITY, FULFILLMENT, SHIPPING_FEE, ADDED_AT)
        VALUES
        (CART_SEQ.NEXTVAL, #{productNo}, #{userId}, #{quantity},#{fulfillment}, #{shippingFee}, SYSDATE)
    </insert>
    
    <!-- 목록 (상품과 조인해서 이름/가격/썸네일 포함) -->
  <select id="selectCartList" parameterType="hashmap" resultType="com.example.TeamProject.model.Cart">
		SELECT
	    C.CART_NO                                           AS cartNo,
	    C.PRODUCT_NO                                        AS productNo,
	    C.USER_ID                                           AS userId,
	    C.OPTION_NO                                         AS optionNo,
	    C.QUANTITY                                          AS quantity,
	    UPPER(NVL(C.FULFILLMENT, 'DELIVERY'))               AS fulfillment,
	    TO_CHAR(C.ADDED_AT, 'YYYY-MM-DD')                   AS addedAt,
	
	    P.PNAME                                             AS pName,
	    NVL(P.PRICE, 0)                                     AS basePrice,
	    NVL(PO.ADD_PRICE, 0)                                AS addPrice,
	
	    -- 단가: 기본가 + 옵션추가금
	    (NVL(P.PRICE, 0) + NVL(PO.ADD_PRICE, 0))            AS unitPrice,
	
	    -- 라인합계: 단가 × 수량
	    ((NVL(P.PRICE, 0) + NVL(PO.ADD_PRICE, 0)) * NVL(C.QUANTITY, 0)) AS lineTotal,
	
	    -- 배송비: 픽업/방문은 0, 그 외 CART의 SHIPPING_FEE(없으면 3000)
	    CASE
	      WHEN UPPER(NVL(C.FULFILLMENT, 'DELIVERY')) IN ('VISIT', 'PICKUP') THEN 0
	      ELSE NVL(C.SHIPPING_FEE, 3000)
	    END                                                 AS shippingFee,
	
	    NVL(PI.THUMB_URL, '/resources/img/no-image.png')    AS thumbPath,
	    PO.UNIT
	
		FROM CART C
		JOIN PRODUCT P
		  ON P.PRODUCT_NO = C.PRODUCT_NO
		LEFT JOIN PRODUCT_OPTION PO
		  ON PO.OPTION_NO = C.OPTION_NO
		LEFT JOIN (
		    SELECT PRODUCT_NO,
		           DBMS_LOB.SUBSTR(IMAGE_URL, 4000, 1) AS THUMB_URL
		    FROM (
		        SELECT PI.*,
		               ROW_NUMBER() OVER (
		                 PARTITION BY PRODUCT_NO
		                 ORDER BY CASE WHEN NVL(PI.IS_THUMBNAIL,'N')='Y' THEN 0 ELSE 1 END,
		                          NVL(PI.SORT_ORDER, 999999),
		                          PI.IMAGE_ID
		               ) RN
		        FROM PRODUCT_IMAGE PI
		    )
		    WHERE RN = 1
		) PI
		  ON PI.PRODUCT_NO = C.PRODUCT_NO
		WHERE C.USER_ID = #{userId}
		ORDER BY C.CART_NO DESC

  </select>

  <!-- 총액(상품합) -->
  <select id="selectCartTotal" parameterType="hashmap" resultType="int">
		SELECT
		NVL(SUM(NVL(P.PRICE,0) * NVL(C.QUANTITY,0)), 0) AS productTotal,
		NVL(SUM(
		CASE
		WHEN NVL(C.FULFILLMENT,'DELIVERY') IN ('VISIT','PICKUP') THEN 0
		ELSE NVL(C.SHIPPING_FEE,3000)
		END
		), 0) AS shippingTotal,
		NVL(SUM(NVL(P.PRICE,0) * NVL(C.QUANTITY,0)), 0)
		+ NVL(SUM(
		CASE
		WHEN NVL(C.FULFILLMENT,'DELIVERY') IN ('VISIT','PICKUP') THEN 0
		ELSE NVL(C.SHIPPING_FEE,3000)
		END
		), 0) AS grandTotal
		FROM CART C
		JOIN PRODUCT P ON P.PRODUCT_NO = C.PRODUCT_NO
		WHERE C.USER_ID = #{userId}
  </select>
  
  <!-- 수량 변경 -->
  <update id="updateQty" parameterType="hashmap">
    UPDATE CART
       SET QUANTITY = #{quantity}
     WHERE CART_NO  = #{cartNo}
       AND USER_ID  = #{userId}
  </update>
  
  <!-- 장바구니 항목 삭제 -->
  <delete id="deleteCartItem" parameterType="hashmap">
    DELETE FROM CART
     WHERE CART_NO = #{cartNo}
       AND USER_ID = #{userId}
  </delete>
  
  <delete id="allDelete" parameterType="hashmap">
		DELETE FROM CART
		WHERE CART_NO IN
		<foreach collection="list" item="item" index="index" open="(" close=")" separator=",">
			#{item}
		</foreach>
  </delete>
  
  <select id="selectCartNoByKey" parameterType="map" resultType="java.lang.Long">
	SELECT CART_NO
	  FROM CART
	  WHERE USER_ID   = #{userId}
	    AND PRODUCT_NO= #{productNo}
	    AND NVL(OPTION_NO, -1) = NVL(#{optionNo}, -1)
	    AND FULFILLMENT = #{fulfillment}
	  FETCH FIRST 1 ROWS ONLY
  </select>
  
  <update id="updateCartQtyByKey" parameterType="map">
	UPDATE CART
	   SET QUANTITY = QUANTITY + #{quantity, jdbcType=NUMERIC},
	       SHIPPING_FEE = #{shippingFee, jdbcType=NUMERIC}
	 WHERE USER_ID = #{userId}
	   AND PRODUCT_NO = #{productNo, jdbcType=NUMERIC}
	   AND NVL(OPTION_NO, -1) = NVL(#{optionNo, jdbcType=NUMERIC}, -1)
	   AND FULFILLMENT = #{fulfillment}
  </update>		
  
  <insert id="insertCarts" parameterType="map">
	  <selectKey keyProperty="cartNo" resultType="long" order="BEFORE">
	    SELECT CART_SEQ.NEXTVAL FROM DUAL
	  </selectKey>
	  INSERT INTO CART(
	    CART_NO, PRODUCT_NO, USER_ID, OPTION_NO, QUANTITY, ADDED_AT, FULFILLMENT, SHIPPING_FEE
	  ) VALUES (
	    #{cartNo, jdbcType=NUMERIC},
	    #{productNo, jdbcType=NUMERIC},
	    #{userId},
	    #{optionNo, jdbcType=NUMERIC},
	    #{quantity, jdbcType=NUMERIC},
	    SYSDATE,
	    #{fulfillment},
	    #{shippingFee, jdbcType=NUMERIC}
	  )
  </insert>
  
  <select id="getSellerProductList" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
  		SELECT P.PRODUCT_NO, P.PNAME, P.PINFO, P.PRICE, P.ORIGIN, P.PRODUCT_STATUS, I.IMAGE_URL, O.UNIT, O.STOCK_QTY, O.ADD_PRICE, O.IS_ACTIVE
		FROM PRODUCT P
		LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO AND I.IS_THUMBNAIL = 'Y'
		LEFT JOIN PRODUCT_OPTION O ON P.PRODUCT_NO = O.PRODUCT_NO
		WHERE SELLER_ID = #{sellerId}
  </select>
  
  <update id="hiddenSellerProduct" parameterType="hashmap">
  		UPDATE PRODUCT
  			SET PRODUCT_STATUS = 'HIDDEN'
  		WHERE PRODUCT_NO = #{productNo}
  </update>
  
  <select id="getsellerProductDetail" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
  		SELECT
		  p.PRODUCT_NO,
		  p.SELLER_ID,
		  p.CATEGORY_NO,
		  p.PNAME,
		  p.PINFO,
		  p.PRICE,
		  p.ORIGIN,
		  p.PRODUCT_STATUS
		FROM PRODUCT p
		WHERE p.PRODUCT_NO = #{productNo}
  </select>
  
  <select id="getsellerProductOption" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
  		SELECT
		  o.OPTION_NO,
		  o.UNIT,
		  NVL(o.ADD_PRICE, 0) AS ADD_PRICE,
		  NVL(o.STOCK_QTY, 0) AS STOCK_QTY
		FROM PRODUCT_OPTION o
		WHERE o.PRODUCT_NO = #{productNo}
		  AND NVL(o.IS_ACTIVE, 'Y') = 'Y'
		ORDER BY o.OPTION_NO
  </select>
  
  <select id="getsellerProductImage" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
  		SELECT
		  i.IMAGE_ID,
		  i.IMAGE_URL,
		  i.IS_THUMBNAIL
		FROM PRODUCT_IMAGE i
		WHERE i.PRODUCT_NO = #{productNo}
		ORDER BY
		  CASE NVL(
		    i.IS_THUMBNAIL, 'N'
		  )
		    WHEN 'Y' THEN 0
		    WHEN 'A' THEN 1
		    ELSE 2
		  END,
		  i.IMAGE_ID
  </select>

  <select id="getsellerProductCategory" parameterType="int" resultType="com.example.TeamProject.model.Product">
  		SELECT
		  t.CATEGORY_NO AS topNo,
		  m.CATEGORY_NO AS midNo,
		  l.CATEGORY_NO AS leafNo
		FROM PRODUCT_CATEGORY l
		LEFT JOIN PRODUCT_CATEGORY m ON m.CATEGORY_NO = l.PARENT_CATEGORY_NO
		LEFT JOIN PRODUCT_CATEGORY t ON t.CATEGORY_NO = m.PARENT_CATEGORY_NO
		WHERE l.CATEGORY_NO = #{categoryNo}
  </select>
  
  <update id="updateProduct" parameterType="map">
	  UPDATE PRODUCT
	     SET CATEGORY_NO = #{categoryNo},
	         PNAME       = #{pname},
	         PINFO       = #{pinfo},
	         PRICE       = #{price},
	         ORIGIN      = #{origin},
	         PRODUCT_STATUS = #{productStatus},
	         UDATETIME   = SYSDATE
	   WHERE PRODUCT_NO = #{productNo}
	</update>
	
	<delete id="deleteOptions" parameterType="map">
	  <if test="optionNos != null and optionNos.size() &gt; 0">
	    DELETE FROM PRODUCT_OPTION
	     WHERE PRODUCT_NO = #{productNo}
	       AND OPTION_NO IN
	       <foreach collection="optionNos" item="no" open="(" separator="," close=")">
	         #{no}
	       </foreach>
	  </if>
	</delete>
	
	<update id="updateOption" parameterType="map">
	  UPDATE PRODUCT_OPTION
	     SET UNIT      = #{unit},
	         ADD_PRICE = #{addPrice},
	         STOCK_QTY = #{stockQty},
	         UDATETIME = SYSDATE
	   WHERE OPTION_NO = #{optionNo}
	     AND PRODUCT_NO = #{productNo}
	</update>
	
	<insert id="insertOption" parameterType="map">
	  INSERT INTO PRODUCT_OPTION(OPTION_NO, PRODUCT_NO, UNIT, STOCK_QTY, ADD_PRICE, IS_ACTIVE, CDATETIME, UDATETIME)
	  VALUES (PRODUCT_OPTION_SEQ.NEXTVAL, #{productNo}, #{unit}, #{stockQty}, #{addPrice}, 'Y', SYSDATE, SYSDATE)
	</insert>
	
	<update id="clearThumbnail" parameterType="int">
	  UPDATE PRODUCT_IMAGE
	     SET IS_THUMBNAIL = 'N'
	   WHERE PRODUCT_NO = #{_parameter}
	</update>
	
	<insert id="insertImage" parameterType="map">
	  INSERT INTO PRODUCT_IMAGE(IMAGE_ID, PRODUCT_NO, IMAGE_URL, IS_THUMBNAIL)
	  VALUES (PRODUCT_IMAGE_SEQ.NEXTVAL, #{productNo}, #{imageUrl}, #{imageType})
	</insert>
	
	<delete id="deleteImages" parameterType="map">
	  <if test="imageNos != null and imageNos.size() &gt; 0">
	    DELETE FROM PRODUCT_IMAGE
	     WHERE PRODUCT_NO = #{productNo}
	       AND IMAGE_ID IN
	       <foreach collection="imageNos" item="no" open="(" separator="," close=")">
	         #{no}
	       </foreach>
	  </if>
	</delete>
  
</mapper>