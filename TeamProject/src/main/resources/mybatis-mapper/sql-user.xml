<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.UserMapper">
	<insert id="insertUser" parameterType="hashmap">
		INSERT INTO USERS
		VALUES(#{userId}, #{userEmail}, #{hashPwd}, #{userName}, #{userPhone}, #{userRole}, #{userAddr}, SYSDATE, SYSDATE, 0, #{lat}, #{lng}, 'ACTIVE', #{userBirth}, #{userGender})
	</insert>
	
	<insert id="insertSeller" parameterType="hashmap">
		INSERT INTO SELLER_INFO
		VALUES(#{userId}, #{businessName}, #{businessLi}, 'N', #{businessNumber}, #{account}, #{bankName}, #{lat}, #{lng}, null)
	</insert>
	
	<select id="idCheck" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<select id="loginUser" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<select id="findId" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE NAME = #{userName} AND EMAIL = #{userEmail}
	</select>
	
	<select id="findPwd" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId} AND NAME = #{userName} AND EMAIL = #{userEmail}
	</select>
	
	<update id="resetPwd" parameterType="hashmap">
		UPDATE USERS
		SET PASSWORD = #{hashPwd}
		WHERE USER_ID = #{userId}
	</update>
	
	<!-- 이메일로 사용자를 찾는 쿼리 -->
	<select id="findByEmail" parameterType="string" resultType="com.example.TeamProject.model.User">
	    SELECT *
	    FROM USERS
	    WHERE EMAIL = #{email}
	</select>

	<!-- 소셜 로그인 사용자를 저장하는 쿼리 -->
	<insert id="insertSocialUser" parameterType="com.example.TeamProject.model.User">
	    INSERT INTO USERS (
	        USER_ID,
	        EMAIL,
	        NAME,
	        USER_ROLE,
	        PASSWORD, <!-- 비밀번호는 null 또는 임의의 값으로 처리 -->
	        PHONE,    
	        ADDRESS, 
	        CDATETIME,
	        UDATETIME
	    ) VALUES (
	        #{userId},
	        #{email},
	        #{name},
	        #{userRole},
	        NULL, <!-- 소셜 로그인 사용자는 비밀번호가 없으므로 임의의 값 지정 -->
	        NVL(#{phone, jdbcType=VARCHAR}, 'NONE'),
	        '소셜 로그인 사용자',    
	        SYSDATE,
	        SYSDATE
	    )
	</insert>
	
	<!-- 소셜 로그인 시 사용자 이름 등을 업데이트 -->
	<update id="updateUser" parameterType="com.example.TeamProject.model.User">
	    UPDATE USERS
		<set>
		    NAME = #{name},
		    <if test="phone != null">
		        PHONE = #{phone, jdbcType=VARCHAR},
		    </if>
		    UDATETIME = SYSDATE
		</set>
		WHERE
   			EMAIL = #{email}
	</update>
	
	<!--유저 프로필 업데이트 -->
	<update id="updateProfile" parameterType="hashmap">
	    UPDATE USERS
	    <set>
	    	EMAIL = #{email},
	        PHONE = #{phone},
	        ADDRESS = #{address},
	        UDATETIME = SYSDATE
	        <if test="hashPwd != null and hashPwd != ''">
	            , PASSWORD = #{hashPwd}
	        </if>
	    </set>
	    WHERE USER_ID = #{userId}
	</update>
	
	<!--계정 삭제 -->
	<update id="updateUserStatus" parameterType="map">
	    UPDATE USERS
	    SET STATUS = #{status},
	        UDATETIME = SYSDATE
	    WHERE USER_ID = #{userId}
	</update>
	
	 <!-- 이미 담은 상품이면 수량만 + N -->
    <update id="updateCartQty" parameterType="hashmap">
        UPDATE CART
        SET
            QUANTITY   = NVL(QUANTITY, 0) + #{quantity},
            ADDED_AT  = SYSDATE
        WHERE USER_ID    = #{userId}
          AND PRODUCT_NO = #{productNo}
    </update>
    
    <!-- 없으면 새로 한 줄 추가 -->
    <insert id="insertCart" parameterType="hashmap">
        INSERT INTO CART
        VALUES
        (CART_SEQ.NEXTVAL, #{productNo}, #{userId}, #{quantity}, SYSDATE)
    </insert>
    
    <!-- 목록 (상품과 조인해서 이름/가격/썸네일 포함) -->
  <select id="selectCartList" parameterType="hashmap" resultType="com.example.TeamProject.model.Cart">
    SELECT C.CART_NO AS cartNo, C.PRODUCT_NO AS productNo, C.USER_ID AS userId,
		      C.QUANTITY AS quantity, TO_CHAR(C.ADDED_AT, 'YYYY-MM-DD') AS addedAt,
		      P.PNAME AS pName, P.PRICE AS price,
		      /* CLOB(IMAGE_URL) → 문자열로 잘라서 가져오기, 없으면 기본 이미지 */
		      NVL(PI.THUMB_URL, '/resources/img/no-image.png') AS thumbPath,
		      (NVL(P.PRICE,0) * NVL(C.QUANTITY,0)) AS lineTotal
		 FROM   CART C
		 JOIN   PRODUCT  P  ON P.PRODUCT_NO = C.PRODUCT_NO
		  /* 상품별 대표 이미지 1장만 선택 */
		 LEFT JOIN (
		      SELECT
		          PRODUCT_NO,
		          /* IMAGE_URL 이 CLOB 이라면 DBMS_LOB.SUBSTR로 4000자까지 꺼내기 */
		          DBMS_LOB.SUBSTR(IMAGE_URL, 4000, 1) AS THUMB_URL
		      FROM ( 
		          SELECT
		              PI.*,
		              ROW_NUMBER() OVER (
		                  PARTITION BY PRODUCT_NO
		                  ORDER BY
		                      CASE WHEN NVL(PI.IS_THUMBNAIL,'N') = 'Y' THEN 0 ELSE 1 END,
		                      NVL(PI.SORT_ORDER, 999999),
		                      PI.IMAGE_ID
		              ) AS RN
		          FROM PRODUCT_IMAGE PI
		      )
		      WHERE RN = 1
		  ) PI ON PI.PRODUCT_NO = C.PRODUCT_NO
		 WHERE  C.USER_ID = #{userId}
		 ORDER BY C.CART_NO DESC
  </select>

  <!-- 총액(상품합) -->
  <select id="selectCartTotal" parameterType="hashmap" resultType="int">
    SELECT NVL(SUM(NVL(P.PRICE,0) * NVL(C.QUANTITY,0)), 0)
    FROM CART C
    INNER JOIN PRODUCT P ON P.PRODUCT_NO = C.PRODUCT_NO
    WHERE C.USER_ID = #{userId}
  </select>
  
  <!-- 수량 변경 -->
  <update id="updateQty" parameterType="hashmap">
    UPDATE CART
       SET QUANTITY = #{quantity}
     WHERE CART_NO  = #{cartNo}
       AND USER_ID  = #{userId}
  </update>
  
  <!-- 장바구니 항목 삭제 -->
  <delete id="deleteCartItem" parameterType="hashmap">
    DELETE FROM CART
     WHERE CART_NO = #{cartNo}
       AND USER_ID = #{userId}
  </delete>
	
</mapper>