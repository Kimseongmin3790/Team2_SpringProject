<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.ProductMapper">
	
	<insert id="insertProduct" parameterType="hashmap" useGeneratedKeys="true" keyColumn="PRODUCT_NO" keyProperty="productNo">
	    INSERT INTO PRODUCT (
	        PRODUCT_NO, SELLER_ID, CATEGORY_NO, PNAME, PINFO,
	        PRICE, ORIGIN, CDATETIME, UDATETIME,
	        RECOMMEND, PRODUCT_STATUS
	    ) VALUES (
	        PRODUCT_SEQ.NEXTVAL, #{sellerId}, #{categoryNo}, #{pname}, #{pinfo},
	        #{price}, #{origin}, SYSDATE, SYSDATE,
	        #{recommend}, #{productStatus}
	    )
	</insert>

	<insert id="insertProductImage" parameterType="hashmap">
	    INSERT INTO PRODUCT_IMAGE (IMAGE_ID, PRODUCT_NO, IS_THUMBNAIL, IMAGE_URL)
	    VALUES (PRODUCT_IMAGE_SEQ.NEXTVAL, #{productNo}, #{isThumbnail}, #{imageUrl})
	</insert>
    
    <select id="selectProduct" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
    	SELECT * FROM PRODUCT
		WHERE PRODUCT_NO = #{productNo}
    </select>
    
    <select id="selectProductOptions" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
    	SELECT O.*
		FROM PRODUCT P
		INNER JOIN PRODUCT_OPTION O ON P.PRODUCT_NO = O.PRODUCT_NO
		WHERE P.PRODUCT_NO = #{productNo}
    </select>
    
    <select id="selectImageList" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
		SELECT
		I.IMAGE_ID AS imageId,
		I.PRODUCT_NO AS productNo,
		UPPER(TRIM(I.IS_THUMBNAIL)) AS isThumbnail, -- 공백/대소문자 정규화
		NVL(I.SORT_ORDER, 9999) AS sortOrder,
		DBMS_LOB.SUBSTR(I.IMAGE_URL, 4000, 1) AS imageUrl
		FROM PRODUCT_IMAGE I
		WHERE I.PRODUCT_NO = #{productNo}
		AND UPPER(TRIM(I.IS_THUMBNAIL)) IN ('A','N') -- 유효한 값만
		ORDER BY
		DECODE(UPPER(TRIM(I.IS_THUMBNAIL)), 'A', 1, 'N', 2, 9), -- A 먼저
		NVL(I.SORT_ORDER, 9999),
		I.IMAGE_ID
	</select>
	
	<select id="selectRecommendList" resultType="com.example.TeamProject.model.Product">
		SELECT
        P.PRODUCT_NO,
        P.PNAME,
        P.PINFO,
        P.PRICE,
        I.IMAGE_URL
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I 
	        ON P.PRODUCT_NO = I.PRODUCT_NO 
	       AND I.IS_THUMBNAIL = 'Y'
	    WHERE P.RECOMMEND = 'Y'
	    ORDER BY P.PRODUCT_NO DESC
	</select>
	
	<select id="selectNewList" resultType="com.example.TeamProject.model.Product">
		SELECT
	        P.PRODUCT_NO,
	        P.PNAME,
	        P.PRICE,
	        I.IMAGE_URL
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I 
	        ON P.PRODUCT_NO = I.PRODUCT_NO 
	       AND I.IS_THUMBNAIL = 'Y'
	    WHERE P.PRODUCT_STATUS = 'SELLING'
	    ORDER BY P.CDATETIME DESC
	</select>
	<select id="selectProductList" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
		SELECT
		P.PRODUCT_NO AS productNo, P.SELLER_ID AS sellerId, P.CATEGORY_NO AS categoryNo,
		P.PNAME AS pName, P.PINFO AS pInfo, P.PRICE AS price,
		P.PRODUCT_STATUS AS productStatus, TO_CHAR(P.CDATETIME, 'YYYY-MM-DD') AS cdate,
		NVL(IMG.IMAGE_URL, '/resources/img/category/noimage.jpg') AS filePath
		FROM PRODUCT P
		LEFT JOIN (
		SELECT PRODUCT_NO, IMAGE_URL
		FROM (
		SELECT
		PRODUCT_NO,
		IMAGE_URL,
		ROW_NUMBER() OVER (
		PARTITION BY PRODUCT_NO
		ORDER BY NVL(SORT_ORDER, 9999), IMAGE_ID
		) AS RN
		FROM PRODUCT_IMAGE
		WHERE UPPER(TRIM(IS_THUMBNAIL)) = 'Y' -- ★ 썸네일만
		)
		WHERE RN = 1
		) IMG
		ON P.PRODUCT_NO = IMG.PRODUCT_NO
		ORDER BY P.PRODUCT_NO
    </select>

   
    <select id="selectCategoryList" parameterType="hashmap" resultType="com.example.TeamProject.model.ProductCategory">
        SELECT 
            C.CATEGORY_NO       AS categoryNo,
            C.CATEGORY_NAME     AS categoryName,
            C.PARENT_CATEGORY_NO AS parentCategoryNo,
            NVL(I.IMAGE_URL, '/resources/img/category/noimage.png') AS imageUrl
        FROM PRODUCT_CATEGORY C
        LEFT JOIN CATEGORY_IMAGE I ON C.CATEGORY_NO = I.CATEGORY_NO
        ORDER BY C.CATEGORY_NO
    </select>
    
    <select id="selectProductQuestions" parameterType="hashmap" resultType="com.example.TeamProject.model.ProductQuestions">
    	SELECT Q.TITLE, Q.USER_ID, Q.STATUS, TO_CHAR(Q.CDATETIME, 'YYYY-MM-DD') AS REG_DATE, A.CONTENT AS ANSWER, Q.IS_SECRET, P.SELLER_ID
		FROM PRODUCT_QNA Q
		JOIN PRODUCT P ON Q.PRODUCT_NO = P.PRODUCT_NO
		LEFT JOIN PRODUCT_QNA_ANSWER A ON Q.QNA_NO = A.QNA_NO
		WHERE Q.PRODUCT_NO = #{productNo}
    </select>
</mapper>