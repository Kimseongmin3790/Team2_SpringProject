<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.ChattingMapper">

  <!-- 단일 테이블 TBL_CHATTING 사용(이전 성공 패턴) -->
  <!-- CHAT_SEQ 시퀀스, 컬럼: CHAT_ID, ROOM_ID, USERID, TYPE, CONTENT, CREATED_AT -->

  <insert id="insertChat" parameterType="hashmap">
    INSERT INTO CHAT_MESSAGE (MSG_NO, ROOM_NO, SENDER_ID, TYPE, CONTENTS, CDATETIME)
  VALUES (CHAT_MESSAGE_SEQ.NEXTVAL, #{roomId}, #{userId}, #{type}, #{content}, SYSDATE)
  </insert>

  <select id="selectHistory" parameterType="hashmap" resultType="com.example.TeamProject.model.ChatMessage">
    SELECT
     MSG_NO    AS chatId,
     ROOM_NO   AS roomId,
     SENDER_ID AS userId,
     TYPE      AS type,
     CONTENTS  AS content,
     /* 오늘이면 HH24:MI:SS, 아니면 날짜+시간 */
     DECODE(TO_CHAR(CDATETIME, 'YY-MM-DD'),
            TO_CHAR(SYSDATE, 'YY-MM-DD'),
            TO_CHAR(CDATETIME, 'HH24:MI:SS'),
            TO_CHAR(CDATETIME, 'YY-MM-DD HH24:MI:SS')) AS cdate
  FROM CHAT_MESSAGE
  WHERE ROOM_NO = #{roomId}
  ORDER BY MSG_NO ASC
  OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
  </select>

  <select id="selectHistoryCnt" parameterType="hashmap" resultType="int">
    SELECT COUNT(*) FROM CHAT_MESSAGE WHERE ROOM_ID = #{roomId}
  </select>

</mapper>
