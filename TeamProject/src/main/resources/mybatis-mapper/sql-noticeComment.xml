<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

 <mapper namespace="com.example.TeamProject.mapper.NoticeCommentMapper">

     <!-- NoticeComment 모델과 DB 컬럼을 매핑합니다. -->
     <resultMap id="commentResultMap" type="com.example.TeamProject.model.NoticeComment">
         <id property="commentNo" column="COMMENT_NO"/>
         <result property="noticeNo" column="NOTICE_NO"/>
         <result property="userId" column="USER_ID"/>
         <result property="contents" column="CONTENTS"/>
         <result property="cdatetime" column="CDATETIME_FORMATTED"/>
         <result property="udatetime" column="UDATETIME_FORMATTED"/>
         <result property="parentCommentNo" column="PARENT_COMMENT_NO"/>
         <result property="level" column="LVL"/>
     </resultMap>

     <!-- 특정 공지사항의 모든 댓글을 계층형으로 조회합니다. -->
     <select id="findByNoticeNo" parameterType="int" resultMap="commentResultMap">
         SELECT
             COMMENT_NO,
             NOTICE_NO,
             USER_ID,
             CONTENTS,
             TO_CHAR(CDATETIME, 'YYYY-MM-DD HH24:MI') AS CDATETIME_FORMATTED,
             TO_CHAR(UDATETIME, 'YYYY-MM-DD HH24:MI') AS UDATETIME_FORMATTED,
             PARENT_COMMENT_NO,
             LEVEL AS LVL
         FROM
             NOTICE_COMMENT
         WHERE
             NOTICE_NO = #{noticeNo}
         START WITH
             PARENT_COMMENT_NO IS NULL
         CONNECT BY
             PRIOR COMMENT_NO = PARENT_COMMENT_NO
         ORDER SIBLINGS BY
             CDATETIME ASC
     </select>

     <!-- 새로운 댓글을 저장합니다. -->
     <insert id="save" parameterType="com.example.TeamProject.model.NoticeComment">
         <!-- INSERT 전에 시퀀스 값을 먼저 조회해서 commentNo에 세팅합니다. -->
         <selectKey keyProperty="commentNo" resultType="int" order="BEFORE">
             SELECT NOTICE_COMMENT_SEQ.NEXTVAL FROM DUAL
         </selectKey>

         INSERT INTO NOTICE_COMMENT (
             COMMENT_NO,
             NOTICE_NO,
             USER_ID,
             CONTENTS,
             PARENT_COMMENT_NO,
             CDATETIME,
             UDATETIME
         ) VALUES (
             #{commentNo},
             #{noticeNo},
             #{userId},
             #{contents},
             #{parentCommentNo, jdbcType=NUMERIC},
             SYSDATE,
             SYSDATE
         )
     </insert>

 </mapper>