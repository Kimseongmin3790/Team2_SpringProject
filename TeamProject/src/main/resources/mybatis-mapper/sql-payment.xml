<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.PaymentMapper">
	
	<insert id="insertOrder" parameterType="hashmap" useGeneratedKeys="false">
	    <selectKey keyProperty="orderNo" order="BEFORE" resultType="int">
	        SELECT ORDERS_SEQ.NEXTVAL FROM DUAL
	    </selectKey>
	    INSERT INTO ORDERS (
	        ORDER_NO,
	        TOTAL_PRICE,
	        STATUS,
	        RECEIV_NAME,
	        RECEIV_PHONE,
	        DELIVER_ADDR,
	        MEMO,
	        ORDERDATE,
	        UDATETIME,
	        BUYER_ID
	    ) VALUES (
	        #{orderNo},
	        #{totalPrice},
	        #{status},
	        #{receivName},
	        #{receivPhone},
	        #{deliverAddr},
	        #{memo},
	        SYSDATE,
	        SYSDATE,
	        #{buyerId}
	    )
	</insert>
	
	
	<insert id="insertPayment" parameterType="hashmap">
	    INSERT INTO PAYMENT (
	        PAYMENT_NO,
	        ORDER_NO,
	        PAYMENT_METHOD,
	        PAYMENT_STATUS,
	        TRANSACTION_NO,
	        AMOUNT,
	        PAID_AT
	    ) VALUES (
	        PAYMENT_SEQ.NEXTVAL,
	        #{orderNo},
	        #{paymentMethod},
	        #{paymentStatus},
	        #{transactionNo},
	        #{amount},
	        SYSDATE
	    )
	</insert>
	
	<!-- params (둘 중 하나의 모드)
	  [장바구니 모드] userId, cartNoList(List<Long>)
	  [단건  모드]  productNo, quantity, optionNo (nullable), fulfillment, shippingFee (nullable)
	-->
	<select id="selectPaymentLines" parameterType="map" resultType="com.example.TeamProject.model.Cart">
	  <choose>
	
	    <!-- 장바구니 모드: cartNoList가 있으면 이 분기 -->
	    <when test="cartNoList != null and cartNoList.size > 0">
	      SELECT
	          C.CART_NO                                        AS cartNo
	        , P.PRODUCT_NO                                     AS productNo
	        , P.PNAME                                          AS pName
	        , P.SELLER_ID                                      AS sellerId
	        , P.PRICE                                          AS basePrice
	        , NVL(O.ADD_PRICE, 0)                              AS addPrice
	        , (P.PRICE + NVL(O.ADD_PRICE, 0))                  AS unitPrice
	        , O.OPTION_NO                                      AS optionNo
	        , O.UNIT                                           AS optionUnit
	        , NVL(O.STOCK_QTY, 0)                              AS stockQty
	        , PI.THUMB_URL                                     AS thumbPath
	        , NVL(C.QUANTITY, 1)                               AS quantity
	        , NVL(C.FULFILLMENT, 'delivery')                   AS fulfillment
	        , CASE
	            WHEN UPPER(NVL(C.FULFILLMENT,'DELIVERY')) = 'DELIVERY'
	              THEN NVL(C.SHIPPING_FEE, 3000)
	            ELSE 0
	          END                                              AS shippingFee
	      FROM CART C
	      JOIN PRODUCT P
	        ON P.PRODUCT_NO = C.PRODUCT_NO
	      LEFT JOIN PRODUCT_OPTION O
	        ON O.OPTION_NO = C.OPTION_NO
	       AND O.PRODUCT_NO = P.PRODUCT_NO
	       AND O.IS_ACTIVE = 'Y'
	      /* 썸네일: IS_THUMBNAIL='Y' 우선, 없으면 첫 번째 한 장 */
	      LEFT JOIN (
	        SELECT PRODUCT_NO,
	               DBMS_LOB.SUBSTR(IMAGE_URL, 4000, 1) AS THUMB_URL
	        FROM (
	          SELECT PRODUCT_NO,
	                 IMAGE_URL,
	                 ROW_NUMBER() OVER (
	                   PARTITION BY PRODUCT_NO
	                   ORDER BY CASE WHEN IS_THUMBNAIL='Y' THEN 0 ELSE 1 END,
	                            NVL(SORT_ORDER, 999999),
	                            IMAGE_ID
	                 ) RN
	          FROM PRODUCT_IMAGE
	        )
	        WHERE RN = 1
	      ) PI
	        ON PI.PRODUCT_NO = P.PRODUCT_NO
	      WHERE C.USER_ID = #{userId}
	        AND C.CART_NO IN
	        <foreach item="no" collection="cartNoList" open="(" separator="," close=")">
	          #{no}
	        </foreach>
	      ORDER BY C.CART_NO DESC
	    </when>
	
	    <!-- 단건(상세) 모드: cartNoList가 없으면 이 분기 -->
	    <otherwise>
	      SELECT *
	      FROM (
	        SELECT
	            P.PRODUCT_NO                                   AS productNo
	          , P.PNAME                                        AS pName
	          , P.SELLER_ID                                    AS sellerId
	          , P.PRICE                                        AS basePrice
	          , NVL(O.ADD_PRICE, 0)                            AS addPrice
	          , (P.PRICE + NVL(O.ADD_PRICE, 0))                AS unitPrice
	          , O.OPTION_NO                                    AS optionNo
	          , O.UNIT                                         AS optionUnit
	          , NVL(O.STOCK_QTY, 0)                            AS stockQty
	          , PI.THUMB_URL                                   AS thumbPath
	          , NVL(#{quantity,    jdbcType=NUMERIC}, 1)       AS quantity
	          , NVL(#{fulfillment, jdbcType=VARCHAR}, 'delivery') AS fulfillment
	          , NVL(
	              #{shippingFee, jdbcType=NUMERIC},
	              CASE
	                WHEN UPPER(NVL(#{fulfillment, jdbcType=VARCHAR}, 'delivery')) = 'DELIVERY'
	                  THEN 3000
	                ELSE 0
	              END
	            )                                              AS shippingFee
	        FROM PRODUCT P
	        /* 옵션은 선택 사항: optionNo가 NULL이면 JOIN이 매칭되지 않아 addPrice=0 으로 계산됨 */
	        LEFT JOIN PRODUCT_OPTION O
	          ON O.PRODUCT_NO = P.PRODUCT_NO
	         AND O.OPTION_NO  = #{optionNo, jdbcType=NUMERIC}
	         AND O.IS_ACTIVE  = 'Y'
	        /* 썸네일: IS_THUMBNAIL='Y' 우선, 없으면 첫 번째 한 장 */
	        LEFT JOIN (
	          SELECT PRODUCT_NO,
	                 DBMS_LOB.SUBSTR(IMAGE_URL, 4000, 1) AS THUMB_URL
	          FROM (
	            SELECT PRODUCT_NO,
	                   IMAGE_URL,
	                   ROW_NUMBER() OVER (
	                     PARTITION BY PRODUCT_NO
	                     ORDER BY CASE WHEN IS_THUMBNAIL='Y' THEN 0 ELSE 1 END,
	                              NVL(SORT_ORDER, 999999),
	                              IMAGE_ID
	                   ) RN
	            FROM PRODUCT_IMAGE
	          )
	          WHERE RN = 1
	        ) PI
	          ON PI.PRODUCT_NO = P.PRODUCT_NO
	        WHERE P.PRODUCT_NO = #{productNo, jdbcType=NUMERIC}
	      )
	      WHERE ROWNUM = 1
	    </otherwise>
	
	  </choose>
	</select>

	
	<select id="selectUserInfo" parameterType="hashmap" resultType="com.example.TeamProject.model.User">
		SELECT *
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<insert id="insertOrderItem" parameterType="hashmap">
		INSERT INTO ORDER_ITEM (ORDER_ITEM_NO, QUANTITY, PRICE, PRODUCT_NO, ORDER_NO, OPTION_NO) 
		VALUES (ORDER_ITEM_SEQ.NEXTVAL, #{quantity}, #{price}, #{productNo}, #{orderNo}, #{optionNo})
	</insert>
	
</mapper>