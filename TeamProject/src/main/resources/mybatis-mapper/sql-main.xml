<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.MainMapper">
    
    <select id="selectMainBanners" resultType="com.example.TeamProject.model.Banner">
        SELECT *
        FROM MAIN_BANNER 
    </select>
    
    <select id="selectRecommendList" resultType="com.example.TeamProject.model.Main">
        SELECT *
		FROM (
		    SELECT 
		        P.PRODUCT_NO,
		        P.PNAME,
		        P.PINFO,
		        P.PRICE,
		        P.CATEGORY_NO,
		        P.RECOMMEND,
		        I.IMAGE_URL
		    FROM PRODUCT P
		    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO
		    WHERE P.RECOMMEND = 'Y'
		    ORDER BY P.CDATETIME DESC
		)
		WHERE ROWNUM &lt;= 8
    </select>
    
    <select id="selectNewList" resultType="com.example.TeamProject.model.Main">
        SELECT *
		FROM (
		    SELECT 
		        P.PRODUCT_NO,
		        P.PNAME,
		        P.PINFO,
		        P.PRICE,
		        P.CATEGORY_NO,
		        P.RECOMMEND,
		        I.IMAGE_URL
		    FROM PRODUCT P
		    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO
		    WHERE I.IS_THUMBNAIL = 'Y'
		    ORDER BY P.CDATETIME DESC
		)
		WHERE ROWNUM &lt;= 8
    </select>
    
    <select id="selectSellerList" parameterType="hashmap" resultType="com.example.TeamProject.model.Producer">
    	SELECT 
	    S.USER_ID,
	    S.BUSINESS_NAME,
	    S.PROFILE_IMG,
	    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(도|특별시|광역시)') AS addrDo,
	    CASE
	        WHEN REGEXP_LIKE(ADDRESS, '광역시') THEN 
	            REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '광역시') + 3)
	        WHEN REGEXP_LIKE(ADDRESS, '특별시') THEN 
	            REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '특별시') + 3)
	        WHEN REGEXP_LIKE(ADDRESS, '도') THEN 
	            REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '도') + 1)
	        ELSE NULL
	    END AS addrCity,
	    S.LAT,
	    S.LNG,
	    CASE 
	        WHEN #{lat, jdbcType=DOUBLE} IS NOT NULL 
	         AND #{lng, jdbcType=DOUBLE} IS NOT NULL THEN 
	            ROUND(
	                6371 * ACOS(
	                    COS(#{lat, jdbcType=DOUBLE} * ACOS(-1) / 180) * COS(S.LAT * ACOS(-1) / 180) *
	                    COS((S.LNG - #{lng, jdbcType=DOUBLE}) * ACOS(-1) / 180) +
	                    SIN(#{lat, jdbcType=DOUBLE} * ACOS(-1) / 180) * SIN(S.LAT * ACOS(-1) / 180)
	                ), 2
	            )
	        ELSE NULL
	    END AS DISTANCE
		FROM SELLER_INFO S
		INNER JOIN USERS U ON S.USER_ID = U.USER_ID
		WHERE S.LAT IS NOT NULL AND S.LNG IS NOT NULL
		ORDER BY DISTANCE ASC NULLS LAST
		FETCH FIRST 10 ROWS ONLY
    </select>
    
    <select id="selectSellerDetail" parameterType="hashmap" resultType="com.example.TeamProject.model.Producer">
		SELECT 
		    S.USER_ID,
		    S.BUSINESS_NAME,
		    S.PROFILE_IMG,
		    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(도|특별시|광역시)') AS addrDo,
		    CASE
                WHEN REGEXP_LIKE(ADDRESS, '광역시') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '광역시') + 3)
                WHEN REGEXP_LIKE(ADDRESS, '특별시') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '특별시') + 3)
                WHEN REGEXP_LIKE(ADDRESS, '도') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '도') + 1)
                ELSE NULL
            END AS addrCity,
			    
		    NVL((
		        SELECT AVG(R.RATING)
		        FROM PRODUCT P
		        JOIN REVIEW R ON R.PRODUCT_NO = P.PRODUCT_NO
		        WHERE P.SELLER_ID = S.USER_ID
		    ), 0) AS AVG_RATING,
			    
		    (SELECT COUNT(*) FROM PRODUCT P WHERE P.SELLER_ID = S.USER_ID) AS PRODUCT_CNT
		
		FROM SELLER_INFO S
	    INNER JOIN USERS U ON S.USER_ID = U.USER_ID
		WHERE S.USER_ID = #{sellerId}
	</select>
	
	<select id="selectSellerProducts" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
	    SELECT 
	        P.PRODUCT_NO,
	        P.PNAME,
	        P.PRICE,
	        P.STOCK,
	        I.IMAGE_URL
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO AND I.IS_THUMBNAIL = 'Y'
	    WHERE P.SELLER_ID = #{sellerId}
	</select>
	
	<select id="selectSearchList" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
		SELECT 
	        P.PRODUCT_NO,
	        P.PNAME,
	        P.PRICE,
	        P.STOCK,
	        I.IMAGE_URL AS IMAGE_URL
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I
	        ON P.PRODUCT_NO = I.PRODUCT_NO
	       AND I.IS_THUMBNAIL = 'Y'
	    WHERE LOWER(P.PNAME) LIKE '%' || LOWER(#{keyword}) || '%'
	       OR LOWER(P.PINFO) LIKE '%' || LOWER(#{keyword}) || '%'
	</select>
	
	<select id="selectUserLocation" parameterType="string" resultType="hashmap">
		SELECT LAT, LNG
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>

</mapper>