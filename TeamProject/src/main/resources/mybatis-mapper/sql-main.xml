<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.TeamProject.mapper.MainMapper">
    
    <select id="selectMainBanners" resultType="com.example.TeamProject.model.Banner">
        SELECT *
        FROM MAIN_BANNER 
    </select>
    
    <select id="selectRecommendList" resultType="com.example.TeamProject.model.Main">
        SELECT *
		FROM (
		    SELECT 
		        P.PRODUCT_NO,
		        P.PNAME,
		        P.PINFO,
		        P.PRICE,
		        P.CATEGORY_NO,
		        P.RECOMMEND,
		        I.IMAGE_URL
		    FROM PRODUCT P
		    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO AND I.IS_THUMBNAIL = 'Y'
		    WHERE P.RECOMMEND = 'Y' AND P.PRODUCT_STATUS = 'SELLING'
		    ORDER BY P.CDATETIME DESC
		)
		WHERE ROWNUM &lt;= 8
    </select>
    
    <select id="selectNewList" resultType="com.example.TeamProject.model.Main">
        SELECT *
		FROM (
		    SELECT 
		        P.PRODUCT_NO,
		        P.PNAME,
		        P.PINFO,
		        P.PRICE,
		        P.CATEGORY_NO,
		        P.RECOMMEND,
		        I.IMAGE_URL
		    FROM PRODUCT P
		    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO
		    WHERE I.IS_THUMBNAIL = 'Y' AND P.PRODUCT_STATUS = 'SELLING'
		    ORDER BY P.CDATETIME DESC
		)
		WHERE ROWNUM &lt;= 8
    </select>
    
    <select id="selectSellerList" parameterType="hashmap" resultType="com.example.TeamProject.model.Producer">
	  SELECT
	    S.USER_ID,
	    S.BUSINESS_NAME,
	    S.PROFILE_IMG,
	    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(도|특별시|광역시)') AS addrDo,
	    CASE
	      WHEN REGEXP_LIKE(ADDRESS, '광역시') THEN 
	        REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '광역시') + 3)
	      WHEN REGEXP_LIKE(ADDRESS, '특별시') THEN 
	        REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '특별시') + 3)
	      WHEN REGEXP_LIKE(ADDRESS, '도') THEN 
	        REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '도') + 1)
	      ELSE NULL
	    END AS addrCity,
	    S.LAT,
	    S.LNG,
	    CASE 
	      WHEN #{lat, jdbcType=DOUBLE} IS NOT NULL 
	       AND #{lng, jdbcType=DOUBLE} IS NOT NULL THEN 
	        ROUND(
	          6371 * ACOS(
	            LEAST(1, GREATEST(-1,
	              COS(#{lat, jdbcType=DOUBLE} * ACOS(-1) / 180) * COS(S.LAT * ACOS(-1) / 180) *
	              COS((S.LNG - #{lng, jdbcType=DOUBLE}) * ACOS(-1) / 180) +
	              SIN(#{lat, jdbcType=DOUBLE} * ACOS(-1) / 180) * SIN(S.LAT * ACOS(-1) / 180)
	            ))
	          ), 2
	        )
	      ELSE NULL
	    END AS DISTANCE
	  FROM SELLER_INFO S
	  INNER JOIN USERS U ON S.USER_ID = U.USER_ID
	  WHERE S.LAT IS NOT NULL AND S.LNG IS NOT NULL
	    AND S.LAT BETWEEN -90 AND 90
	    AND S.LNG BETWEEN -180 AND 180
	  ORDER BY DISTANCE ASC NULLS LAST
	</select>
    
    <select id="selectSellerDetail" parameterType="hashmap" resultType="com.example.TeamProject.model.Producer">
		SELECT 
		    S.USER_ID,
		    S.BUSINESS_NAME,
		    S.PROFILE_IMG,
		    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(도|특별시|광역시)') AS addrDo,
		    CASE
                WHEN REGEXP_LIKE(ADDRESS, '광역시') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '광역시') + 3)
                WHEN REGEXP_LIKE(ADDRESS, '특별시') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '특별시') + 3)
                WHEN REGEXP_LIKE(ADDRESS, '도') THEN 
                    REGEXP_SUBSTR(ADDRESS, '[가-힣]+(시|군|구)', INSTR(ADDRESS, '도') + 1)
                ELSE NULL
            END AS addrCity,
			    
		    NVL((
		        SELECT AVG(R.RATING)
		        FROM PRODUCT P
		        JOIN REVIEW R ON R.PRODUCT_NO = P.PRODUCT_NO
		        WHERE P.SELLER_ID = S.USER_ID
		    ), 0) AS AVG_RATING,
			    
		    (SELECT COUNT(*) FROM PRODUCT P WHERE P.SELLER_ID = S.USER_ID) AS PRODUCT_CNT
		
		FROM SELLER_INFO S
	    INNER JOIN USERS U ON S.USER_ID = U.USER_ID
		WHERE S.USER_ID = #{sellerId}
	</select>
	
	<select id="selectSellerProducts" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
	    SELECT 
	        P.PRODUCT_NO 		AS productNo,
	        P.PNAME     		AS pName,
	        P.PINFO		 		AS pInfo,
	        P.PRICE      		AS price,
	        P.ORIGIN     		AS origin,
	        TO_CHAR(P.CDATETIME, 'YYYY-MM-DD') AS cdate,	        
	        I.IMAGE_URL,
	        
	        U.NAME				AS userName,
	        SI.BUSINESS_NAME    AS businssName,   
	        
	        REGEXP_REPLACE(
            	REGEXP_SUBSTR(U.ADDRESS, '^[^ ]+ [^ ]+'),
            	'(특별시|광역시|도|특별자치도)',
            	''
       		) AS region, 
       		
       		NVL(ROUND(R.RATING, 1), 0) AS rating  
	           
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I ON P.PRODUCT_NO = I.PRODUCT_NO AND I.IS_THUMBNAIL = 'Y'
	    
	    LEFT JOIN USERS U ON P.SELLER_ID = U.USER_ID
	    LEFT JOIN SELLER_INFO SI ON U.USER_ID = SI.USER_ID
	    LEFT JOIN (
	        SELECT PRODUCT_NO, AVG(RATING) AS RATING
	        FROM REVIEW
	        GROUP BY PRODUCT_NO
	    ) R ON P.PRODUCT_NO = R.PRODUCT_NO
	    
	    WHERE P.SELLER_ID = #{sellerId} AND P.PRODUCT_STATUS = 'SELLING'
	
	    ORDER BY P.PRODUCT_NO	    
	    
	</select>
	
	<select id="selectSearchList" parameterType="hashmap" resultType="com.example.TeamProject.model.Product">
		SELECT 
	        P.PRODUCT_NO,
	        P.PNAME,
	        P.PINFO,
	        P.PRICE,
	        I.IMAGE_URL AS IMAGE_URL,
	        TO_CHAR(P.CDATETIME, 'YY-MM-DD') AS CDATE,
	        P.ORIGIN,
	        S.BUSINESS_NAME
	    FROM PRODUCT P
	    LEFT JOIN PRODUCT_IMAGE I
	        ON P.PRODUCT_NO = I.PRODUCT_NO
	       AND I.IS_THUMBNAIL = 'Y'
	    INNER JOIN SELLER_INFO S ON P.SELLER_ID = S.USER_ID
	    WHERE LOWER(P.PNAME) LIKE '%' || LOWER(#{keyword}) || '%'
	    AND P.PRODUCT_STATUS = 'SELLING'
	</select>
	
	<select id="selectUserLocation" parameterType="string" resultType="hashmap">
		SELECT LAT, LNG
		FROM USERS
		WHERE USER_ID = #{userId}
	</select>
	
	<!-- 지역별 특산물 리스트 -->
    <select id="selectRegionalSpecialList" resultType="hashmap">
        SELECT
            REGION_ID      AS regionId,
            REGION_NAME    AS regionName,
            TITLE          AS title,
            DESCRIPTION    AS description,
            THUMBNAIL_URL  AS imageUrl,
            BASE_PRICE     AS price
        FROM REGION_SPECIAL
        WHERE IS_ACTIVE = 'Y'
        ORDER BY
            DISPLAY_ORDER NULLS LAST,
            REGION_ID DESC
    </select>

    <!-- 정기배송 플랜 리스트 -->
    <select id="selectSubscriptionPlanList" resultType="hashmap">
        SELECT
            PLAN_ID      AS planId,
            PLAN_NAME    AS planName,
            SHORT_DESC   AS shortDesc,
            PERIOD_TYPE  AS periodType,
            BASE_PRICE   AS price,
            IMAGE_URL    AS imageUrl
        FROM SUBSCRIPTION_PLAN
        WHERE IS_ACTIVE = 'Y'
        ORDER BY
            DISPLAY_ORDER NULLS LAST,
            PLAN_ID DESC
    </select>

</mapper>